<div class="grid gap-8 lg:grid-cols-[1.25fr,0.75fr]">
  <section class="space-y-6">
    <div class="glass-card p-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Today’s meals</h2>
          <p class="text-xs text-slate-500">{{ meals().length }} logged • {{ totalCalories() | number:'1.0-0' }} kcal</p>
        </div>
        <button
          type="button"
          class="rounded-xl border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-600"
          (click)="toggleManualEntry()"
        >
          {{ manualMode() ? 'Close manual entry' : 'Add manual entry' }}
        </button>
      </div>
      @if (manualMode()) {
        <div class="mt-4 rounded-2xl border border-dashed border-slate-200 bg-white/80 p-5">
          <form class="grid gap-4 text-sm text-slate-600" [formGroup]="manualForm" (ngSubmit)="saveManualEntry()">
            <div class="grid gap-4 sm:grid-cols-2">
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                Meal type
                <select
                  formControlName="mealType"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-100"
                >
                  <option value="breakfast">Breakfast</option>
                  <option value="lunch">Lunch</option>
                  <option value="dinner">Dinner</option>
                  <option value="snack">Snack</option>
                  <option value="meal">Other</option>
                </select>
              </label>
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                Description
                <input
                  type="text"
                  formControlName="description"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-100"
                  placeholder="e.g. Grilled salmon bowl"
                />
                @if (manualForm.get('description')?.invalid && manualForm.get('description')?.touched) {
                  <span class="mt-1 block text-xs text-red-500">Description is required.</span>
                }
              </label>
            </div>
            <div class="grid gap-4 sm:grid-cols-4">
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                Calories
                <input
                  type="number"
                  min="0"
                  formControlName="calories"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-100"
                />
              </label>
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                Protein (g)
                <input
                  type="number"
                  min="0"
                  formControlName="protein"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-100"
                />
              </label>
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                Carbs (g)
                <input
                  type="number"
                  min="0"
                  formControlName="carbs"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-100"
                />
              </label>
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                Fat (g)
                <input
                  type="number"
                  min="0"
                  formControlName="fat"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-100"
                />
              </label>
            </div>
            @if (manualError()) {
              <div class="rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-600">
                {{ manualError() }}
              </div>
            }
            <div class="flex items-center justify-end gap-3">
              <button
                type="button"
                class="rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-500 hover:border-slate-300"
                (click)="toggleManualEntry()"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="rounded-xl bg-gradient-to-r from-sky-500 to-emerald-500 px-4 py-2 text-xs font-semibold text-white shadow-lg transition hover:from-sky-400 hover:to-emerald-400 disabled:cursor-not-allowed disabled:opacity-60"
                [disabled]="manualSubmitting()"
              >
                @if (manualSubmitting()) {
                  <span class="iconify mr-2 animate-spin text-base" data-icon="mdi:loading"></span>
                }
                Save manual entry
              </button>
            </div>
          </form>
        </div>
      }
      <div class="mt-4 space-y-3 text-sm text-slate-200">
        @if (mealsLoading()) {
          <div class="flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white/80 px-4 py-3 text-xs text-slate-500">
            <span class="iconify animate-spin text-base" data-icon="mdi:loading"></span>
            Loading meals…
          </div>
        } @else if (meals().length) {
          @for (meal of meals(); track meal.id) {
            <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-white/85 px-4 py-3 text-slate-700">
              <div>
                <p class="font-semibold text-slate-800">{{ meal.description }}</p>
                <p class="text-xs text-slate-500">{{ meal.mealType | titlecase }} • {{ meal.calories | number:'1.0-0' }} kcal</p>
                <p class="mt-1 text-[11px] text-slate-400">P: {{ meal.protein | number:'1.0-0' }}g • C: {{ meal.carbs | number:'1.0-0' }}g • F: {{ meal.fat | number:'1.0-0' }}g</p>
              </div>
              <div class="flex items-center gap-3 text-xs text-slate-400">
                <span>{{ meal.createdAt | date:'shortTime' }}</span>
                <button
                  type="button"
                  class="text-slate-400 transition hover:text-red-500"
                  (click)="deleteMeal(meal)"
                  aria-label="Delete meal"
                >
                  <span class="iconify text-lg" data-icon="mdi:delete-outline"></span>
                </button>
              </div>
            </div>
          }
        } @else {
          <p class="rounded-xl border border-dashed border-slate-200 bg-white/70 px-4 py-6 text-center text-xs text-slate-500">
            No meals logged yet. Add a manual entry to get started.
          </p>
        }
      </div>
    </div>
  </section>

  <aside class="space-y-6">
    <div class="glass-card p-6 text-sm text-slate-600">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-sky-500">Today's breakdown</p>
      <div class="mt-3 grid gap-4 text-slate-800 sm:grid-cols-2">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Meals logged</p>
          <p class="text-2xl font-semibold">{{ meals().length }}</p>
          <p class="text-xs text-slate-500">Total {{ totalCalories() | number:'1.0-0' }} kcal</p>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Avg calories/meal</p>
          <p class="text-2xl font-semibold">
            @if (meals().length) {
              {{ (totalCalories() / meals().length) | number:'1.0-0' }}
            } @else {
              0
            }
          </p>
          <p class="text-xs text-slate-500">kcal per entry</p>
        </div>
      </div>
      <div class="mt-4 grid gap-3 text-xs text-slate-500">
        <div class="rounded-xl border border-slate-200 bg-white/85 p-3">
          <p class="flex items-center justify-between text-slate-600">
            <span>Protein</span>
            <span class="text-sm font-semibold text-sky-600">{{ macroTotals().protein | number:'1.0-0' }} g</span>
          </p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white/85 p-3">
          <p class="flex items-center justify-between text-slate-600">
            <span>Carbs</span>
            <span class="text-sm font-semibold text-emerald-600">{{ macroTotals().carbs | number:'1.0-0' }} g</span>
          </p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white/85 p-3">
          <p class="flex items-center justify-between text-slate-600">
            <span>Fat</span>
            <span class="text-sm font-semibold text-amber-600">{{ macroTotals().fat | number:'1.0-0' }} g</span>
          </p>
        </div>
      </div>
    </div>
    <div class="glass-card p-6 text-sm text-slate-600">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-500">Macro balance</p>
      <p class="mt-2 text-xs text-slate-500">
        {{ meals().length ? 'A snapshot of today’s macros across all meals.' : 'Log meals to see macro trends here.' }}
      </p>
      <div class="mt-4 space-y-2 text-xs text-slate-500">
        <div
          class="h-2 rounded-full bg-slate-100"
          aria-hidden="true"
        >
          <div
            class="h-full rounded-full bg-gradient-to-r from-sky-500 via-emerald-500 to-amber-400 transition-all"
            [style.width.%]="meals().length ? 100 : 0"
          ></div>
        </div>
        <ul class="flex flex-wrap gap-4 text-slate-600">
          <li><span class="text-sky-500">●</span> Protein {{ macroTotals().protein | number:'1.0-0' }} g</li>
          <li><span class="text-emerald-500">●</span> Carbs {{ macroTotals().carbs | number:'1.0-0' }} g</li>
          <li><span class="text-amber-500">●</span> Fat {{ macroTotals().fat | number:'1.0-0' }} g</li>
        </ul>
      </div>
    </div>
  </aside>
</div>
